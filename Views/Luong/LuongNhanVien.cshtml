

@{
    ViewBag.Title = "DanhSachLuongNhanVien";
    Layout = "~/Views/Shared/_LayoutMaster.cshtml";
}
<style>
    .select2 {
        margin-left: -5%;
    }

/*    .dataTables_filter, .dataTables_info {
        display: none;
    }*/

    #sua-vi-tri .form-group > input {
        height: 30px;
        border-radius: 5px;
        padding-left: 8px !important;
    }

    input[readonly] {
        background: #ccc
    }

    .disabled-dia-chi {
        pointer-events: none;
        opacity: 0.4;
    }

    #tb-import-vitri input {
        height: 30px;
        border-radius: 5px;
        width: 100%;
        padding: 5px;
    }

    .was-validated input:required:valid, input:required.is-valid {
        border-color: #15af76;
        background-image: url('/App_themes/assets/images/btn-tick.png');
        background-repeat: no-repeat;
        background-position: right calc(.375em + .23438rem) center;
    }

    .was-validated input:required:invalid {
        border-color: #ff0000;
        background-image: url(/App_themes/assets/images/error-form.png);
        background-repeat: no-repeat;
        background-position: right calc(.375em + 0.1rem) center;
    }
</style>
<main class="wrapper">
    <div class="container-fluid">
        <div class="wrap-table__header">
            <div class="row">
                <div class="col-md-12">
                    <div class="box-choose-time" id="date-vitri">
                        <p class="mr-2">Tháng</p>
                        <select class="mr-2" name="chooseDate_From">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                        </select>
                        <div class="list-button">
                            <a href="#" class="btn btn-export
                            inline" id="btn-search-congviec">
                                <img src="/App_Themes/assets/images/btn-search.png" alt="" class="inline"><span class="inline">Tìm kiếm</span>
                            </a>
                            @*<a href="#" class="btn btn-add inline" id="btn-them-cong-viec">
                                    <img src="/App_Themes/assets/images/btn-add.png"
                                         alt="" class="inline">
                                    <span class="inline">Thêm</span>
                                </a>
                                <a href="#" class="btn btn-del inline" id="btn-xoa-cong-viec">
                                    <img src="/App_Themes/assets/images/btn-del.png"
                                         alt="" class="inline"><span class="inline">Xóa</span>
                                </a>*@
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="wrap-table__body">
            <div class="wrap-height-table">
                <table class="table display table-striped" style="width: 100%;"
                       id="table-danh-sach-luong">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Nhân viên</th>
                            <th>Lương</th>
                            <th>Tổng số ngày nghỉ</th>
                            <th>Tổng tiền nghỉ</th>
                            <th>Tổng tiền ứng trước</th>
                            <th>Số ngày làm việc</th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
</main>

@section myScripts{
    <script>
        $(document).ready(function () {
            $('select[name="chooseDate_From"]').val(moment(new Date()).format('M'));
            let thang = moment(new Date()).format('M');
            let tbDanhSachLuong_filterValues = {};
            //$('#table-danh-sach-luong thead tr').clone(true).appendTo('#table-danh-sach-luong thead');
            //$('#table-danh-sach-luong thead tr:eq(1) th').each(function (i) {
            //    var title = $(this).text();
            //    if (i == 0 || i == 2 || i == 4 || i == 6 || i == 8) {
            //        return $(this).html('');
            //    }
            //    else if (i == 5) {
            //        $(this).html('<select data-search-xin-nghi="' + i + '"><option value ="0">Đang chờ duyệt</option> <option value ="1">Từ chối</option> <option value ="2">Duyệt</option><option value ="3">Hủy</option><option value ="-1">Tất cả</option> </select>');
            //    }
            //    else {
            //        $(this).html('<input type="text" placeholder="Search ' + title.trim() + '" data-search-xin-nghi="' + i + '"/>');
            //    }
            //    $('input', this).on('keyup change', delay(function () {
            //        console.log(this.value);
            //        console.log(table_danhsachluong.column(i).search());
            //        $(this.value !== table_danhsachluong.column(i).search())
            //        {
            //            table_danhsachluong
            //                .column(i)
            //                .search(this.value)
            //                .draw();
            //        }
            //    }, 1000));
            //    $('select', this).on('change', function () {
            //        table_danhsachluong.draw();
            //    });
            //});
            var table_danhsachluong = $('#table-danh-sach-luong').DataTable({
                serverSide: true,
                bFilter: false,
                bInfo: false,
                "order": [[1, "desc"]],
                ajax: function (data, callback, settings) {
                    tbDanhSachLuong_filterValues.draw = data.draw;
                    tbDanhSachLuong_filterValues.search = data.search["value"];
                    tbDanhSachLuong_filterValues.thang = thang;
                    tbDanhSachLuong_filterValues.start = data.start;
                    tbDanhSachLuong_filterValues.length = data.length;
                    tbDanhSachLuong_filterValues.order = data.order[0].column;
                    tbDanhSachLuong_filterValues.dir = data.order[0].dir;
                    $.ajax({
                        url: '/Luong/LoadDanhSachLuongNhanVien',
                        method: 'GET',
                        data: tbDanhSachLuong_filterValues,
                        success: function (msg) {
                            console.log(msg);
                            console.log(msg.data);
                            if (msg.status == 2) {
                                toast.create({
                                    title: 'Notification!',
                                    text: msg.message,
                                    icon: 'error_outline',
                                    classBackground: 'noti-error',
                                    timeout: 3000
                                });
                                return false;
                            } else if (msg.status == 3) {
                                if (tbDanhSachLuong_filterValues.draw != 1) {
                                    toast.create({
                                        title: 'Notification!',
                                        text: msg.message,
                                        icon: 'error_outline',
                                        classBackground: 'noti-error',
                                        timeout: 3000
                                    });
                                    location.reload();
                                    return false;
                                }
                            }
                        },
                    }).done(callback, () => {

                    });
                },
                columns: [
                    {
                        "data": null,
                    },
                    { "data": "nhanVienTen" },
                    {
                        "data": "luongCoBan",
                        render: function (data) {
                            return data.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
                        }
                    },
                    { "data": "tongSoNgayNghi" },
                    { "data": "tongTienNghiNhanVien" },
                    { "data": "tongTienUngTruoc" },
                    { "data": "soNgayLamViec"},
                ],
                columnDefs: [
                    {
                        "targets": [0],
                        "orderable": false
                    },
                ],
                //fnCreatedRow: function (nRow, data, iDataIndex) {
                //    $(nRow).attr('data-id', data.donXinNghiPhepID);
                //},
                "fnRowCallback": function (nRow, aData, iDisplayIndex) {
                    var info = $(this).DataTable().page.info();
                    $("td:nth-child(1)", nRow).html(info.start + iDisplayIndex + 1);
                    return nRow;
                },
                scroller: {
                    loadingIndicator: true,
                    displayBuffer: 15
                },
                // scrollY: '300px',
                scrollResize: true,
                scrollY: 100,
                scrollCollapse: true,
                paging: true,
                searching: true,
                lengthChange: false,
                orderCellsTop: true
            });
            //Search ngày -> ngày
            $('#btn-search-congviec').click(function () {
                thang = $('select[name="chooseDate_From"]').val();
                table_danhsachluong.columns.adjust().draw();
            });

            //Click
            $(document).on('click', '#table-danh-sach-luong tbody tr', function () {
                $(this).addClass('selected');
                $('#table-danh-sach-luong tbody tr').not(this).removeClass('selected');
            });
        });
        serialize = function (obj) {
            var str = [];
            for (var p in obj)
                if (obj.hasOwnProperty(p)) {
                    str.push(encodeURIComponent(p) + "=" + encodeURIComponent(obj[p]));
                }
            return str.join("&");
        }
        function delay(fn, ms) {
            let timer = 0
            return function (...args) {
                clearTimeout(timer)
                timer = setTimeout(fn.bind(this, ...args), ms || 0)
            }
        }
    </script>
}

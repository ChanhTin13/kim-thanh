

@{
    ViewBag.Title = "DapUngHang";
    Layout = "~/Views/Shared/_LayoutMaster.cshtml";
}
<link href="~/App_Themes/select2/css/select2.min.css" rel="stylesheet" />
<style>
    #sua-vi-tri .form-group > input {
        height: 30px;
        border-radius: 5px;
        padding-left: 8px !important;
    }

    input[readonly] {
        background: #ccc
    }

    #tb-import-vitri input {
        height: 30px;
        border-radius: 5px;
        width: 100%;
        padding: 5px;
    }
</style>
<main class="wrapper">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <div class="box-check-code" style="width:40%">
                    <div class="box-check-input list-button">
                        <input style="width:22%;background-color:snow;padding-left:3%;margin-left:5%;" name="txt-ShowRoom" id="ShowRoom" disabled />
                        <button id="btn-create-file-excel" class="btn btn-default ">
                            <img src="/App_Themes/assets/images/paste-excel.png"
                                 alt=""> Mẫu nhập
                        </button>

                        <input type="file" id="FileUploadBHHD" style="display: none" />
                        <button id="btnFileUploadBHHD" class="btn btn-default ">
                            <img src="/App_Themes/assets/images/paste-excel.png"
                                 alt=""> Nhập
                        </button>

                        <input type="file" id="FileUploadBHHD2" style="display: none" />
                        <button id="btnFileUploadBHHD2" class="btn btn-default ">
                            <img src="/App_Themes/assets/images/paste-excel.png"
                                 alt=""> Trả KQ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="wrap-table__header">
            <div class="row">
                <div class="col-md-12">
                    <div class="box-choose-time" id="date-vitri">
                        <p class="mr-2">Từ</p>
                        <input class="mr-2 datetimepicker date-only" name="chooseDate_From" data-date-format="mm/dd/yyyy">
                        <p class="mr-2">Đến</p>
                        <input class="mr-2 datetimepicker date-only" name="chooseDate_To" data-date-format="mm/dd/yyyy">
                        <div class="list-button">
                            <a href="#" class="btn btn-export
                            inline" id="btn-search-phienkiemhang">
                                <img src="/App_Themes/assets/images/btn-search.png" alt="" class="inline"><span class="inline">Tìm kiếm</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="wrap-table__body">
            <div class="wrap-height-table">
                <table class="table display table-striped" style="width: 100%;"
                       id="table-dap-ung-hang">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Ngày tạo</th>
                            <th>Mã NV yêu cầu</th>
                            <th>Số lượng Mã hàng</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
</main>

@section myScripts{
    <script src="~/App_Themes/select2/js/select2.full.min.js"></script>
    <script>
        $(document).ready(function () {
            $('input[name="chooseDate_From"]').val(moment(new Date()).format('DD/MM/yyyy'));
            $('input[name="chooseDate_To"]').val(moment(new Date()).format('DD/MM/yyyy'));
            let fdate = moment(new Date()).format('DD/MM/yyyy');
            let tdate = moment(new Date()).format('DD/MM/yyyy');
            $(function () {
                $.ajax({
                    async: true,
                    type: 'GET',
                    url: '/DapUngHang/LoadChiNhanh',
                    success: function (res) {
                        if (res.rs) {
                            $('input[name="txt-ShowRoom"]').val(res.data);
                        }
                    }
                });
            })
            let tbDapUngHang_filterValues = {};
            //$('#table-phien-kiem-hang thead tr').clone(true).appendTo('#table-phien-kiem-hang thead');
            //$('#table-phien-kiem-hang thead tr:eq(1) th').each(function (i) {
            //    var title = $(this).text();
            //    if (i == 0 || i == 5) {
            //        return $(this).html('');
            //    }
            //    else {
            //        $(this).html('<input type="text" placeholder="Search ' + title.trim() + '" data-search-vitri-mathang="' + i + '"/>');
            //    }
            //    $('input', this).on('keyup change', delay(function () {
            //        table_dapunghang
            //            .column(i)
            //            .search(this.value)
            //            .draw();
            //    }, 1000));
            //});
            var table_dapunghang = $('#table-dap-ung-hang').DataTable({
                serverSide: true,
                bFilter: false,
                bInfo: false,
                "order": [[1, "desc"]],
                ajax: function (data, callback, settings) {
                    tbDapUngHang_filterValues.draw = data.draw;
                    tbDapUngHang_filterValues.search = data.search["value"];
                    tbDapUngHang_filterValues.FromDate = fdate;
                    tbDapUngHang_filterValues.ToDate = tdate;
                    tbDapUngHang_filterValues.start = data.start;
                    tbDapUngHang_filterValues.length = data.length;
                    tbDapUngHang_filterValues.order = data.order[0].column;
                    tbDapUngHang_filterValues.dir = data.order[0].dir;

                    tbDapUngHang_filterValues.SearchMaNhapKho = $('input[data-search-vitri-mathang=1]').val();
                    tbDapUngHang_filterValues.SearchNCC = $('input[data-search-vitri-mathang=2]').val();
                    tbDapUngHang_filterValues.SearchNguoiLap = $('input[data-search-vitri-mathang=3]').val();
                    tbDapUngHang_filterValues.SearchGhiChu = $('input[data-search-vitri-mathang=4]').val();

                    $.ajax({
                        url: '/DapUngHang/LoadDataDapUngHang',
                        method: 'GET',
                        data: tbDapUngHang_filterValues,
                        success: function (msg) {
                            console.log(msg.data);
                            if (msg.status == 2) {
                                toast.create({
                                    title: 'Notification!',
                                    text: msg.message,
                                    icon: 'error_outline',
                                    classBackground: 'noti-error',
                                    timeout: 3000
                                });
                                return false;
                            } else if (msg.status == 3) {
                                if (tbDapUngHang_filterValues.draw != 1) {
                                    toast.create({
                                        title: 'Notification!',
                                        text: msg.message,
                                        icon: 'error_outline',
                                        classBackground: 'noti-error',
                                        timeout: 3000
                                    });
                                    location.reload();
                                    return false;
                                }
                            }
                        },
                    }).done(callback, () => {

                    });
                },
                columns: [
                    { "data": null },
                    { "data": "NGAYTAOString" },
                    { "data": "NGUOITAO" },
                    { "data": "SOLUONGMAHANG" },
                    {
                        "data": "IDPHIEUHANG",
                        render: function (data, type, row) {
                            return '<a type="button" id="print-xephang-thanhtoan" value="' + data + '" class="btn btn-success text-white mr-1 btn-custom">Xuất Excel</a>';
                        }
                    }
                ],
                columnDefs: [
                    {
                        "targets": [0,4],
                        "orderable": false
                    },
                ],
                fnCreatedRow: function (nRow, data, iDataIndex) {
                    $(nRow).attr('data-id', data.IDPHIEUHANG);
                },
                "fnRowCallback": function (nRow, aData, iDisplayIndex) {
                    var info = $(this).DataTable().page.info();
                    $("td:nth-child(1)", nRow).html(info.start + iDisplayIndex + 1);
                    return nRow;
                },
                scroller: {
                    loadingIndicator: true,
                    displayBuffer: 15
                },
                // scrollY: '300px',
                scrollResize: true,
                scrollY: 100,
                scrollCollapse: true,
                bInfo: false,
                paging: true,
                searching: false,
                pageLength: 5,
                lengthChange: false,
                orderCellsTop: true
            });

            //Search ngày -> ngày
            $('#btn-search-phienkiemhang').click(function () {
                fdate = $('#date-vitri input[name="chooseDate_From"]').val();
                tdate = $('#date-vitri input[name="chooseDate_To"]').val();
                table_dapunghang.columns.adjust().draw();
            });

            //Click
            $(document).on('click', '#table-dap-ung-hang tbody tr', function () {
                $(this).addClass('selected');
                $('#table-dap-ung-hang tbody tr').not(this).removeClass('selected');
            });

            $('#table-dap-ung-hang tbody').on('click', 'a[type="button"]', function () {
                var id = $(this).attr('value');
                $.ajax({
                    method: "GET",
                    url: "/DapUngHang/CheckRoleXuat",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (msg) {
                        if (msg.status == 1) {
                            var link = `/DapUngHang/ExcelCTDapUngHang?IDPHIEUHANG=` + id + ``;
                            window.open(link)
                        }
                        else if (msg.status == 2) {
                            toast.create({
                                title: 'Notification!',
                                text: msg.message,
                                icon: 'error_outline',
                                classBackground: 'noti-error',
                                timeout: 3000
                            });
                        }
                        else if (msg.status == 3) {
                            toast.create({
                                title: 'Notification!',
                                text: msg.message,
                                icon: 'error_outline',
                                classBackground: 'noti-error',
                                timeout: 3000
                            });
                            location.reload();
                        }
                    }
                })
            });
            
            $("#btnFileUploadBHHD").click(function () {
                $("#FileUploadBHHD").click();
            })
            $("#FileUploadBHHD").change(function (event) {
                UploadFile(event, true);
            })

            $("#btnFileUploadBHHD2").click(function () {
                $("#FileUploadBHHD2").click();
            })
            $("#FileUploadBHHD2").change(function (event) {
                UploadFile(event, false);
            })

            

            function UploadFile(event,nhap ) {
                let input, files;
                input = event.target;
                files = input.files;
                Array.from(files).map((file, index) => {
                    var formdata = new FormData();
                    formdata.append('fileupload', file);
                    formdata.append('nhap', nhap);
                    $.ajax({
                        async: false,
                        type: 'POST',
                        url: '/DapUngHang/Import',
                        data: formdata,
                        dataType: 'json',
                        contentType: false,
                        processData: false,
                        success: function (msg) {
                            console.log(msg);
                            console.log(nhap);
                            if (msg.status == 1) {
                                toast.create({
                                    title: 'Notification!',
                                    text: 'Thành công',
                                    icon: 'check',
                                    classBackground: 'noti-success',
                                    timeout: 3000
                                });
                                table_dapunghang.columns.adjust().draw();
                                if (nhap == false) {
                                    var link = `/DapUngHang/ExcelCTDapUngHang?IDPHIEUHANG=` + msg.data[0].IDPHIEUHANG + ``;
                                    window.open(link)
                                }
                                $("#FileUploadBHHD").val('');
                                $("#FileUploadBHHD2").val('');
                            }
                            else if (msg.status == 2) {
                                toast.create({
                                    title: 'Notification!',
                                    text: msg.message,
                                    icon: 'error_outline',
                                    classBackground: 'noti-error',
                                    timeout: 3000
                                });
                                $("#FileUploadBHHD").val('');
                                $("#FileUploadBHHD2").val('');
                            }
                        },
                        error: function (error) {
                            toast.create({
                                title: 'Notification!',
                                text: 'Không thành công, vui lòng kiểm tra file import và thử lại',
                                icon: 'error_outline',
                                classBackground: 'noti-error',
                                timeout: 3000
                            });
                            $("#FileUploadBHHD").val('');
                            $("#FileUploadBHHD2").val('');
                        }
                    });
                })
            }

            // Nút Tạo Excel nhập liệu
            $('#btn-create-file-excel').on('click', function () {
                var link = `/DapUngHang/CreateDapUngHangExcel`
                window.open(link)
            })
            //#endregion

        });
        serialize = function (obj) {
            var str = [];
            for (var p in obj)
                if (obj.hasOwnProperty(p)) {
                    str.push(encodeURIComponent(p) + "=" + encodeURIComponent(obj[p]));
                }
            return str.join("&");
        }
        function delay(fn, ms) {
            let timer = 0
            return function (...args) {
                clearTimeout(timer)
                timer = setTimeout(fn.bind(this, ...args), ms || 0)
            }
        }
    </script>
}
